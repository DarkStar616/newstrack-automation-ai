<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newstrack Keyword Automation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2c3e50;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            margin-top: 30px;
            display: none;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            margin: 0 5px;
            border-radius: 6px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #667eea;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .results h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .category {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .category h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .keyword {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 2px;
        }
        
        /* Region Toggle Controls */
        .region-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .region-controls h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .toggle-group {
            display: flex;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .toggle-option {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
            border-right: 1px solid #dee2e6;
        }
        
        .toggle-option:last-child {
            border-right: none;
        }
        
        .toggle-option.active {
            background: #667eea;
            color: white;
        }
        
        .country-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .country-picker label {
            margin: 0;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .country-picker select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
            width: auto;
            min-width: 150px;
        }
        
        /* Flag and Region Chips */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin: 2px;
        }
        
        .region-chip {
            background: #e8f5e8;
            color: #2d5a2d;
        }
        
        .region-chip.include {
            background: #d4edda;
            color: #155724;
        }
        
        .region-chip.exclude {
            background: #f8d7da;
            color: #721c24;
        }
        
        .region-chip.global {
            background: #e2e3e5;
            color: #6c757d;
        }
        
        .flag-chip {
            cursor: pointer;
            position: relative;
        }
        
        .flag-chip.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .flag-chip.low {
            background: #fff3cd;
            color: #856404;
        }
        
        .flag-chip.medium {
            background: #f8d7da;
            color: #721c24;
        }
        
        .flag-chip.high {
            background: #f5c6cb;
            color: #721c24;
        }
        
        .recency-badge {
            background: #28a745;
            color: white;
            font-size: 0.7em;
        }
        
        .recency-badge.outdated {
            background: #ffc107;
            color: #212529;
        }
        
        .debug-toggle {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7em;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .debug-query {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.8em;
            margin-top: 8px;
            display: none;
            color: #495057;
        }
        
        .keyword-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .keyword-name {
            font-weight: 600;
            color: #2c3e50;
            margin-right: 8px;
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .flag-chip:hover .tooltip {
            opacity: 1;
        }
        
        .category-chip {
            background: #6f42c1;
            color: white;
            font-size: 0.7em;
        }
        
        .keywords-enhanced {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .metadata {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 6px;
            font-size: 0.9em;
            color: #2d5a2d;
        }
        
        .metadata h4 {
            margin-bottom: 10px;
            color: #1e4620;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .metadata-item {
            display: flex;
            justify-content: space-between;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .guardrails-info {
            margin-top: 15px;
            padding: 12px;
            background: #fff3cd;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            font-size: 0.9em;
        }
        
        .guardrails-info h5 {
            margin-bottom: 8px;
            color: #856404;
        }
        
        .guardrails-list {
            color: #856404;
        }
        
        /* Enhanced Results Styles */
        .step-section {
            margin: 25px 0;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .step-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e6ed;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .step-content {
            padding: 20px;
        }
        
        .three-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .column-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }
        
        .removed-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        }
        
        .removed-item {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #dc3545;
        }
        
        .removed-keyword {
            font-weight: 600;
            color: #dc3545;
        }
        
        .removed-reason {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .guardrails-summary {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .guardrails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .guardrail-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #d4e6d4;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .evidence-section {
            margin: 20px 0;
        }
        
        .evidence-keyword {
            margin: 10px 0;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .evidence-keyword summary {
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #e0e6ed;
        }
        
        .evidence-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        
        .evidence-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .evidence-item:last-child {
            border-bottom: none;
        }
        
        .evidence-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .evidence-title a {
            color: #1976d2;
            text-decoration: none;
        }
        
        .evidence-title a:hover {
            text-decoration: underline;
        }
        
        .evidence-meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .evidence-snippet {
            color: #2c3e50;
            line-height: 1.4;
        }
        
        .raw-json-section {
            margin: 20px 0;
        }
        
        .json-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .json-toggle:hover {
            background: #5a6268;
        }
        
        .json-content {
            margin-top: 15px;
            background: #f8f9fa;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .json-content pre {
            margin: 0;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #2c3e50;
        }
        
        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 10px;
            }
            
            .container {
                margin: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .three-column-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .guardrails-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Newstrack Keyword Automation</h1>
            <p>Enterprise-grade keyword processing with guardrails and audit trails</p>
        </div>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>System Operational</span>
            </div>
            <div id="systemStatus">Loading status...</div>
        </div>
        
        <div class="form-container">
            <form id="keywordForm">
                <!-- Region Controls -->
                <div class="region-controls">
                    <h4>🌍 Region Scope</h4>
                    <div class="toggle-group" id="regionToggle">
                        <button type="button" class="toggle-option active" data-mode="global">Global</button>
                        <button type="button" class="toggle-option" data-mode="include">Country only</button>
                        <button type="button" class="toggle-option" data-mode="exclude">Everywhere but Country</button>
                    </div>
                    <div class="country-picker">
                        <label for="countrySelect">Country:</label>
                        <select id="countrySelect" name="country">
                            <option value="South Africa" selected>South Africa</option>
                            <option value="United States">United States</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="Australia">Australia</option>
                            <option value="Canada">Canada</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="India">India</option>
                            <option value="China">China</option>
                            <option value="Japan">Japan</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sector">Sector:</label>
                    <input type="text" id="sector" name="sector" placeholder="e.g., short-term insurance" required>
                </div>
                
                <div class="form-group">
                    <label for="company">Company (optional):</label>
                    <input type="text" id="company" name="company" placeholder="e.g., Santam">
                </div>
                
                <div class="form-group">
                    <label for="keywords">Keywords (one per line):</label>
                    <textarea id="keywords" name="keywords" placeholder="Enter keywords, one per line..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date">Current Date:</label>
                    <input type="text" id="date" name="date" value="2025-08" required>
                </div>
                
                <!-- Evidence Mode Controls -->
                <details style="margin-bottom: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; margin-bottom: 15px;">Evidence Mode Settings (Optional)</summary>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; margin-top: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="search_mode">Search Mode:</label>
                                <select id="search_mode" name="search_mode">
                                    <option value="">Default</option>
                                    <option value="off">Off</option>
                                    <option value="shallow">Shallow</option>
                                    <option value="deep">Deep</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="recency_window_months">Recency (months):</label>
                                <input type="number" id="recency_window_months" name="recency_window_months" placeholder="e.g., 3" min="1" max="12">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="max_results_per_keyword">Max results/keyword:</label>
                                <select id="max_results_per_keyword" name="max_results_per_keyword">
                                    <option value="">Default</option>
                                    <option value="3">3</option>
                                    <option value="6">6</option>
                                </select>
                            </div>
                        </div>
                        <!-- Runtime status badge -->
                        <div id="runtime-status" style="margin-top: 15px; padding: 10px; border-radius: 4px; font-size: 0.9em; display: none;">
                            <strong>Current Mode:</strong> <span id="current-mode"></span>
                        </div>
                    </div>
                </details>
                
                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="processKeywords('categorize')">
                        1. Categorize Only
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="processKeywords('expand')">
                        2. Expand Categories
                    </button>
                    <button type="button" class="btn btn-success" onclick="processKeywords('process-all')">
                        3. Full Process
                    </button>
                    <button type="button" class="btn btn-info" onclick="processKeywords('drop')">
                        4. Drop Outdated
                    </button>
                </div>
            </form>
            
            <!-- CSV Upload Section -->
            <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e9ecef;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    📊 CSV Bulk Upload
                    <span style="font-size: 0.7em; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-weight: 500;">Auto-batching</span>
                </h3>
                
                <div id="csvUploadSection">
                    <div class="form-group">
                        <label for="csvFile">Select CSV File:</label>
                        <input type="file" id="csvFile" accept=".csv,.txt" style="padding: 10px; border: 2px dashed #dee2e6; border-radius: 8px; width: 100%; background: #f8f9fa;">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">
                            Supports UTF-8, Windows-1252 encoding. Max 25,000 rows. 
                            <a href="/api/keywords/csv-template" style="color: #667eea; text-decoration: none;">Download template</a>
                        </small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="csvSector">Sector:</label>
                            <input type="text" id="csvSector" placeholder="e.g., Short-term Insurance" required style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label for="batchSize">Batch Size:</label>
                            <select id="batchSize" style="width: 100%;" disabled>
                                <option value="200" selected>200 keywords (fixed)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="csvSearchMode">Processing Mode:</label>
                            <select id="csvSearchMode" style="width: 100%;">
                                <option value="shallow" selected>Live (Shallow)</option>
                                <option value="deep">Live (Deep)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="uploadCSV()" id="uploadBtn">
                            📤 Upload & Process CSV
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showCSVPreview()" id="previewBtn" disabled>
                            👀 Preview CSV
                        </button>
                    </div>
                    
                    <div id="csvPreview" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">CSV Preview</h4>
                        <div id="csvPreviewContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Batch Progress Section -->
            <div id="batchProgressSection" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                <h4 style="margin-bottom: 15px; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                    ⚡ Batch Processing Status
                    <span id="batchGroupId" style="font-size: 0.7em; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-weight: 500;"></span>
                </h4>
                
                <div id="batchOverallProgress" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Overall Progress</span>
                        <span id="batchProgressText">0 / 0 batches</span>
                    </div>
                    <div style="width: 100%; height: 12px; background: #e9ecef; border-radius: 6px; overflow: hidden;">
                        <div id="batchProgressBar" style="height: 100%; background: linear-gradient(90deg, #28a745, #20c997); width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #28a745;" id="completedCount">0</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Completed</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #ffc107;" id="inProgressCount">0</div>
                        <div style="font-size: 0.8em; color: #6c757d;">In Progress</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #dc3545;" id="failedCount">0</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Failed</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #17a2b8;" id="totalKeywords">0</div>
                        <div style="font-size: 0.8em; color: #6c757d;">Keywords</div>
                    </div>
                </div>
                
                <div id="batchResults" style="display: none;">
                    <div class="button-group">
                        <button type="button" class="btn btn-success" onclick="downloadBatchResults()" id="downloadBtn">
                            📥 Download Results CSV
                        </button>
                        <button type="button" class="btn btn-info" onclick="viewBatchResults()" id="viewResultsBtn">
                            👁️ View Results
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-steps">
                    <div class="step" id="step1">Categorize</div>
                    <div class="step" id="step2">Expand</div>
                    <div class="step" id="step3">Drop Outdated</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="loading" id="loadingMessage">
                    <div class="spinner"></div>
                    <div>Processing keywords with guardrails...</div>
                </div>
            </div>
            
            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        const steps = ['step1', 'step2', 'step3'];
        
        // Load system status on page load
        window.addEventListener('load', loadSystemStatus);
        
        // Initialize region toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeRegionToggle();
        });
        
        function initializeRegionToggle() {
            const toggleOptions = document.querySelectorAll('.toggle-option');
            const countrySelect = document.getElementById('countrySelect');
            
            toggleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    toggleOptions.forEach(opt => opt.classList.remove('active'));
                    // Add active class to clicked option
                    this.classList.add('active');
                    
                    // Update UI based on selection
                    const mode = this.dataset.mode;
                    updateRegionMode(mode);
                });
            });
        }
        
        function updateRegionMode(mode) {
            const countryPicker = document.querySelector('.country-picker');
            
            if (mode === 'global') {
                countryPicker.style.opacity = '0.5';
                countryPicker.style.pointerEvents = 'none';
            } else {
                countryPicker.style.opacity = '1';
                countryPicker.style.pointerEvents = 'auto';
            }
        }
        
        function getRegionConfig() {
            const activeToggle = document.querySelector('.toggle-option.active');
            const mode = activeToggle.dataset.mode;
            const country = document.getElementById('countrySelect').value;
            
            return {
                mode: mode,
                country: mode === 'global' ? null : country
            };
        }
        
        function formatRegionChip(regionMode, country) {
            if (regionMode === 'GLOBAL' || !country) {
                return '<span class="chip region-chip global">Global</span>';
            } else if (regionMode === 'INCLUDE') {
                return `<span class="chip region-chip include">${country} only</span>`;
            } else if (regionMode === 'EXCLUDE') {
                return `<span class="chip region-chip exclude">!${country}</span>`;
            }
            return '<span class="chip region-chip global">Global</span>';
        }
        
        function formatFlagChips(flags) {
            if (!flags || flags.length === 0) {
                return '<span class="chip flag-chip info">Clean</span>';
            }
            
            return flags.map(flag => {
                const severityClass = flag.severity || 'info';
                return `<span class="chip flag-chip ${severityClass}" title="${flag.reason}">
                    ${flag.label || flag.code}
                    <span class="tooltip">${flag.reason}</span>
                </span>`;
            }).join('');
        }
        
        function formatRecencyBadge(evidenceRefs, recencyWindowMonths = 3) {
            if (!evidenceRefs || evidenceRefs.length === 0) {
                return '<span class="chip recency-badge outdated">No Evidence</span>';
            }
            
            const now = new Date();
            const cutoffDate = new Date(now.getFullYear(), now.getMonth() - recencyWindowMonths, now.getDate());
            
            const recentEvidence = evidenceRefs.filter(ref => {
                if (!ref.published_date) return false;
                const pubDate = new Date(ref.published_date);
                return pubDate >= cutoffDate;
            });
            
            if (recentEvidence.length === 0) {
                return '<span class="chip recency-badge outdated">Outdated</span>';
            }
            
            const recentDays = Math.ceil((now - new Date(Math.max(...recentEvidence.map(r => new Date(r.published_date))))) / (1000 * 60 * 60 * 24));
            return `<span class="chip recency-badge">≤${recentDays}d</span>`;
        }
        
        function toggleDebugQuery(element, query) {
            const debugDiv = element.nextElementSibling;
            if (debugDiv && debugDiv.classList.contains('debug-query')) {
                debugDiv.style.display = debugDiv.style.display === 'block' ? 'none' : 'block';
            } else {
                const newDebugDiv = document.createElement('div');
                newDebugDiv.className = 'debug-query';
                newDebugDiv.textContent = query || 'Query not available';
                newDebugDiv.style.display = 'block';
                element.parentNode.insertBefore(newDebugDiv, element.nextSibling);
            }
        }
        
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (status.manifest) {
                    const totalBatches = status.manifest.totals.total_batches;
                    const totalKeywords = status.manifest.totals.total_keywords_processed;
                    document.getElementById('systemStatus').textContent = 
                        `Processed ${totalBatches} batches, ${totalKeywords} keywords this month`;
                } else {
                    document.getElementById('systemStatus').textContent = 'Ready for first processing';
                }
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'Status unavailable';
            }
        }
        
        function updateProgress(step, completed = false) {
            // Reset all steps
            steps.forEach(s => {
                document.getElementById(s).classList.remove('active', 'completed');
            });
            
            // Mark completed steps
            for (let i = 0; i < step; i++) {
                document.getElementById(steps[i]).classList.add('completed');
            }
            
            // Mark current step as active (unless completed)
            if (!completed && step < steps.length) {
                document.getElementById(steps[step]).classList.add('active');
            }
            
            // Update progress bar
            const progress = completed ? 100 : (step / steps.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        // HTML escaping function to prevent XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Safe URL validation
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }
        
        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (data.error) {
                resultsDiv.innerHTML = `<div class="error">${escapeHtml(data.error)}</div>`;
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '<h3>Processing Results</h3>';
            
            // Extract step results and metadata
            const step1_result = data.step1_result || {};
            const step2_result = data.step2_result || {};
            const step3_result = data.step3_result || {};
            const final_result = data.final_result || {};
            
            // Keep existing metadata section
            const metadata = {
                batch_id: data.batch_id,
                timing_ms: data.timing_ms,
                processed_count: data.processed_count
            };
            
            if (Object.keys(metadata).some(key => metadata[key])) {
                html += `
                    <div class="metadata">
                        <h4>Processing Metadata</h4>
                        <div class="metadata-grid">
                            ${metadata.batch_id ? `<div class="metadata-item"><span>Batch ID:</span><span>${escapeHtml(String(metadata.batch_id))}</span></div>` : ''}
                            ${metadata.timing_ms ? `<div class="metadata-item"><span>Processing Time:</span><span>${escapeHtml(String(metadata.timing_ms))}ms</span></div>` : ''}
                            ${metadata.processed_count ? `<div class="metadata-item"><span>Keywords Processed:</span><span>${escapeHtml(String(metadata.processed_count))}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Step 1: Categories + Explanations
            if (step1_result.categories || step1_result.explanations) {
                html += `
                    <div class="step-section">
                        <details open>
                            <summary class="step-header">Step 1: Categorization</summary>
                            <div class="step-content">
                                <div class="three-column-grid">
                                    <div>
                                        <div class="column-header">Industry</div>
                                        <div class="keywords">
                                            ${(step1_result.categories?.industry || []).map(keyword => `<span class="keyword">${escapeHtml(keyword)}</span>`).join('')}
                                        </div>
                                        ${step1_result.explanations?.industry ? `<p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">${escapeHtml(step1_result.explanations.industry)}</p>` : ''}
                                    </div>
                                    <div>
                                        <div class="column-header">Company</div>
                                        <div class="keywords">
                                            ${(step1_result.categories?.company || []).map(keyword => `<span class="keyword">${escapeHtml(keyword)}</span>`).join('')}
                                        </div>
                                        ${step1_result.explanations?.company ? `<p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">${escapeHtml(step1_result.explanations.company)}</p>` : ''}
                                    </div>
                                    <div>
                                        <div class="column-header">Regulatory</div>
                                        <div class="keywords">
                                            ${(step1_result.categories?.regulatory || []).map(keyword => `<span class="keyword">${escapeHtml(keyword)}</span>`).join('')}
                                        </div>
                                        ${step1_result.explanations?.regulatory ? `<p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">${escapeHtml(step1_result.explanations.regulatory)}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                `;
            }
            
            // Step 2: Expanded Terms
            if (step2_result.categories) {
                html += `
                    <div class="step-section">
                        <details open>
                            <summary class="step-header">Step 2: Expanded Terms</summary>
                            <div class="step-content">
                                <div class="three-column-grid">
                                    <div>
                                        <div class="column-header">Industry</div>
                                        <div class="keywords">
                                            ${(step2_result.categories.industry || []).map(keyword => `<span class="keyword">${escapeHtml(keyword)}</span>`).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="column-header">Company</div>
                                        <div class="keywords">
                                            ${(step2_result.categories.company || []).map(keyword => `<span class="keyword">${escapeHtml(keyword)}</span>`).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="column-header">Regulatory</div>
                                        <div class="keywords">
                                            ${(step2_result.categories.regulatory || []).map(keyword => `<span class="keyword">${escapeHtml(keyword)}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                `;
            }
            
            // Step 3: Flagged Keywords (Enhanced Format)
            if (step3_result.updated || final_result.updated || final_result.flags) {
                const updated = step3_result.updated || final_result.updated || {};
                const flags = final_result.flags || {};
                const evidenceRefs = final_result.evidence_refs || step3_result.evidence_refs || {};
                const recencyWindow = data.runtime_config?.recency_window_months || 3;
                
                html += `
                    <div class="step-section">
                        <details open>
                            <summary class="step-header">🏁 Step 3: Evidence Validation & Flagging</summary>
                            <div class="step-content">
                                <h4>All Keywords (None Removed - Flagged Instead)</h4>`;
                
                // Create a comprehensive list of all keywords from all categories
                const allKeywords = [];
                ['industry', 'company', 'regulatory'].forEach(category => {
                    if (updated[category]) {
                        updated[category].forEach(keyword => {
                            allKeywords.push({
                                keyword: keyword,
                                category: category,
                                flags: flags[keyword] || [],
                                evidenceRefs: evidenceRefs[keyword] || [],
                                // Mock region data - in real implementation, this would come from the API
                                regionMode: 'GLOBAL', // This would be set based on source_location
                                country: null
                            });
                        });
                    }
                });
                
                if (allKeywords.length > 0) {
                    html += `<div class="keywords-enhanced">`;
                    
                    allKeywords.forEach(item => {
                        const regionChip = formatRegionChip(item.regionMode, item.country);
                        const flagChips = formatFlagChips(item.flags);
                        const recencyBadge = formatRecencyBadge(item.evidenceRefs, recencyWindow);
                        const debugQuery = `${data.runtime_config?.sector || 'sector'} ${item.keyword}${item.country ? ` (${item.regionMode === 'INCLUDE' ? '' : '!'}${item.country})` : ''}`;
                        
                        html += `
                            <div class="keyword-row">
                                <span class="keyword-name">${escapeHtml(item.keyword)}</span>
                                <span class="chip category-chip">${item.category}</span>
                                ${regionChip}
                                ${flagChips}
                                ${recencyBadge}
                                <button class="debug-toggle" onclick="toggleDebugQuery(this, '${escapeHtml(debugQuery)}')">🔍</button>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                } else {
                    html += `<p style="color: #6c757d; font-style: italic;">No keywords processed yet.</p>`;
                }
                
                // Summary stats
                const totalKeywords = allKeywords.length;
                const flaggedKeywords = allKeywords.filter(item => item.flags.length > 0).length;
                const cleanKeywords = totalKeywords - flaggedKeywords;
                
                html += `
                    <div class="summary-stats" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <h5>Summary</h5>
                        <div style="display: flex; gap: 20px; font-size: 0.9em;">
                            <span><strong>Total:</strong> ${totalKeywords}</span>
                            <span><strong>Clean:</strong> ${cleanKeywords}</span>
                            <span><strong>Flagged:</strong> ${flaggedKeywords}</span>
                            <span><strong>Removed:</strong> 0 (Flagged instead)</span>
                        </div>
                    </div>
                `;
                
                html += `</div></details></div>`;
            }
            
            // Guardrails Summary
            const guardrails = data.guardrails || final_result.guardrails || step3_result.guardrails || {};
            if (Object.keys(guardrails).length > 0) {
                const counts = guardrails.counts || {};
                const completeness = guardrails.completeness_check || {};
                
                html += `
                    <div class="guardrails-summary">
                        <h4>Guardrails Summary</h4>
                        <div class="guardrails-grid">
                            <div class="guardrail-stat">
                                <div class="stat-number">${counts.input_total || 0}</div>
                                <div class="stat-label">Input Total</div>
                            </div>
                            <div class="guardrail-stat">
                                <div class="stat-number">${counts.output_accounted || 0}</div>
                                <div class="stat-label">Output Accounted</div>
                            </div>
                            <div class="guardrail-stat">
                                <div class="stat-number">${counts.duplicates_dropped || 0}</div>
                                <div class="stat-label">Duplicates Dropped</div>
                            </div>
                            <div class="guardrail-stat">
                                <div class="stat-number">${counts.leaks_blocked || 0}</div>
                                <div class="stat-label">Leaks Blocked</div>
                            </div>
                        </div>
                        ${!completeness.is_complete && completeness.missing_keywords ? `
                            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                                <strong>Completeness Check Failed</strong><br>
                                Missing keywords: ${completeness.missing_keywords.map(k => escapeHtml(k)).join(', ')}
                            </div>
                        ` : completeness.is_complete ? `
                            <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 4px; border-left: 3px solid #28a745;">
                                <strong>✓ Completeness Check Passed</strong>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Evidence Mode Section
            const evidence_refs = step3_result.evidence_refs || final_result.evidence_refs || {};
            if (Object.keys(evidence_refs).length > 0) {
                html += `
                    <div class="evidence-section">
                        <h4>Evidence Mode Results</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">Real-time evidence gathered for keyword validation:</p>
                `;
                
                Object.entries(evidence_refs).forEach(([keyword, evidenceList]) => {
                    if (evidenceList && evidenceList.length > 0) {
                        html += `
                            <details class="evidence-keyword">
                                <summary>${escapeHtml(keyword)} (${evidenceList.length} evidence items)</summary>
                                <ul class="evidence-list">
                                    ${evidenceList.map(evidence => `
                                        <li class="evidence-item">
                                            <div class="evidence-title">
                                                ${evidence.url && isValidUrl(evidence.url) ? `<a href="${escapeHtml(evidence.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(evidence.title || 'News Article')}</a>` : escapeHtml(evidence.title || 'News Article')}
                                            </div>
                                            <div class="evidence-meta">
                                                Published: ${escapeHtml(evidence.published_date || 'Unknown')} | Provider: ${escapeHtml(evidence.provider || 'Unknown')}
                                            </div>
                                            <div class="evidence-snippet">${escapeHtml(evidence.snippet || 'No snippet available')}</div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </details>
                        `;
                    }
                });
                
                html += `</div>`;
            }
            
            // Raw JSON Toggle
            const jsonId = escapeHtml(String(data.batch_id || Date.now()));
            html += `
                <div class="raw-json-section">
                    <button class="json-toggle" onclick="toggleRawJson('${jsonId}')">Show Raw JSON</button>
                    <div id="json-${jsonId}" class="json-content" style="display: none;">
                        <pre></pre>
                    </div>
                </div>
            `;
            
            // Safely set JSON content after DOM insertion
            setTimeout(() => {
                const jsonContainer = document.getElementById(`json-${jsonId}`);
                if (jsonContainer) {
                    const preElement = jsonContainer.querySelector('pre');
                    if (preElement) {
                        preElement.textContent = JSON.stringify(data, null, 2);
                    }
                }
            }, 0);
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // Update runtime status badge
            updateRuntimeStatus(data.runtime_config);
        }
        
        function updateRuntimeStatus(runtime_config) {
            if (!runtime_config) return;
            
            const statusDiv = document.getElementById('runtime-status');
            const modeSpan = document.getElementById('current-mode');
            
            if (!statusDiv || !modeSpan) return;
            
            const modeText = `${runtime_config.search_mode} (${runtime_config.provider})`;
            
            modeSpan.textContent = modeText;
            
            // Always show live mode (test mode removed)
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `<strong>✓ Live mode active</strong><br>Mode: ${escapeHtml(modeText)}`;
            
            statusDiv.style.display = 'block';
        }
        
        function toggleRawJson(id) {
            const jsonDiv = document.getElementById(`json-${id}`);
            const button = jsonDiv.previousElementSibling;
            
            if (jsonDiv.style.display === 'none') {
                jsonDiv.style.display = 'block';
                button.textContent = 'Hide Raw JSON';
            } else {
                jsonDiv.style.display = 'none';
                button.textContent = 'Show Raw JSON';
            }
        }
        
        async function processKeywords(action) {
            const form = document.getElementById('keywordForm');
            const formData = new FormData(form);
            
            // Get region configuration
            const regionConfig = getRegionConfig();
            
            const data = {
                sector: formData.get('sector'),
                company: formData.get('company'),
                keywords: formData.get('keywords'),
                current_date: formData.get('date')
            };
            
            // Add region configuration for evidence gathering
            if (regionConfig.mode !== 'global' && regionConfig.country) {
                const sourceLocation = regionConfig.mode === 'include' ? regionConfig.country : `!${regionConfig.country}`;
                data.source_location = sourceLocation;
            }
            
            // Add optional Evidence Mode parameters if they have values with validation
            const searchMode = formData.get('search_mode');
            const recencyWindow = formData.get('recency_window_months');
            const maxResults = formData.get('max_results_per_keyword');
            
            if (searchMode && searchMode !== '' && ['off', 'test', 'shallow', 'deep'].includes(searchMode)) {
                data.search_mode = searchMode;
            }
            if (recencyWindow && recencyWindow !== '') {
                const recencyNum = parseInt(recencyWindow);
                if (!isNaN(recencyNum) && recencyNum >= 1 && recencyNum <= 12) {
                    data.recency_window_months = recencyNum;
                }
            }
            if (maxResults && maxResults !== '') {
                const maxNum = parseInt(maxResults);
                if (!isNaN(maxNum) && (maxNum === 3 || maxNum === 6)) {
                    data.max_results_per_keyword = maxNum;
                }
            }
            
            // Disable buttons
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);
            
            showProgress();
            
            try {
                let endpoint;
                let expectedSteps;
                
                switch (action) {
                    case 'categorize':
                        endpoint = '/api/categorize';
                        expectedSteps = 1;
                        updateProgress(0);
                        break;
                    case 'expand':
                        endpoint = '/api/expand';
                        expectedSteps = 2;
                        updateProgress(0);
                        break;
                    case 'drop':
                        endpoint = '/api/drop';
                        expectedSteps = 3;
                        updateProgress(2);
                        break;
                    case 'process-all':
                        endpoint = '/api/process-all';
                        expectedSteps = 3;
                        updateProgress(0);
                        break;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Idempotency-Key': `web-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    updateProgress(expectedSteps, true);
                    setTimeout(() => {
                        hideProgress();
                        showResults(result);
                        loadSystemStatus(); // Refresh status after processing
                    }, 500);
                } else {
                    hideProgress();
                    showResults({ error: result.error || 'An error occurred' });
                }
                
            } catch (error) {
                hideProgress();
                showResults({ error: 'Network error: ' + error.message });
            } finally {
                // Re-enable buttons
                buttons.forEach(btn => btn.disabled = false);
            }
        }
        
        // Set default date to current month
        document.getElementById('date').value = new Date().toISOString().slice(0, 7);
        
        // CSV Upload functionality
        let currentBatchGroupId = null;
        let batchStatusInterval = null;
        
        // Enable preview button when file is selected
        document.getElementById('csvFile').addEventListener('change', function() {
            const previewBtn = document.getElementById('previewBtn');
            previewBtn.disabled = !this.files.length;
        });
        
        async function showCSVPreview() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }
            
            const previewDiv = document.getElementById('csvPreview');
            const previewContent = document.getElementById('csvPreviewContent');
            
            // Show loading state
            previewContent.innerHTML = '<div style="text-align: center; padding: 20px;"><i>🔄 Analyzing CSV format...</i></div>';
            previewDiv.style.display = 'block';
            
            try {
                // Use server-side CSV analysis with encoding detection
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/keywords/csv-preview', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let html = '';
                    
                    // Show detected format information
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 0.9em;">
                        <strong>📋 Detected Format:</strong><br>
                        <span style="color: #1976d2;">Encoding:</span> ${result.encoding} | 
                        <span style="color: #1976d2;">Delimiter:</span> ${result.delimiter} | 
                        <span style="color: #1976d2;">Total rows:</span> ${result.total_rows} | 
                        <span style="color: #1976d2;">Valid keywords:</span> ${result.valid_keywords}
                    </div>`;
                    
                    // Show preview table
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">';
                    result.preview.forEach((row, index) => {
                        const isHeader = index === 0;
                        html += `<tr style="background: ${isHeader ? '#e9ecef' : 'white'};">`;
                        row.forEach(cell => {
                            const style = `padding: 8px; border: 1px solid #dee2e6; ${isHeader ? 'font-weight: 600;' : ''}`;
                            html += `<td style="${style}">${escapeHtml(cell)}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    if (result.total_rows > 10) {
                        html += `<p style="margin-top: 10px; font-size: 0.8em; color: #6c757d;">... and ${result.total_rows - 10} more rows</p>`;
                    }
                    
                    previewContent.innerHTML = html;
                } else {
                    previewContent.innerHTML = `<div style="color: #dc3545;">❌ ${result.error || 'Failed to analyze CSV'}</div>`;
                }
                
            } catch (error) {
                previewContent.innerHTML = `<div style="color: #dc3545;">❌ Error analyzing file: ${escapeHtml(error.message)}</div>`;
            }
        }
        
        async function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const sectorInput = document.getElementById('csvSector');
            const batchSizeSelect = document.getElementById('batchSize');
            const searchModeSelect = document.getElementById('csvSearchMode');
            
            // Validation
            if (!fileInput.files.length) {
                alert('Please select a CSV file.');
                return;
            }
            
            if (!sectorInput.value.trim()) {
                alert('Please enter a sector.');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.textContent;
            
            try {
                // Disable button and show loading
                uploadBtn.disabled = true;
                uploadBtn.textContent = '⏳ Uploading...';
                
                // Prepare form data
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('sector', sectorInput.value.trim());
                formData.append('batch_size', batchSizeSelect.value);
                formData.append('search_mode', searchModeSelect.value);
                formData.append('current_date', new Date().toISOString().slice(0, 10));
                
                // Upload CSV
                const response = await fetch('/api/keywords/upload-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Show success and start monitoring
                    currentBatchGroupId = result.group_id;
                    showBatchProgress(result);
                    startBatchMonitoring();
                    
                    // Clear the form
                    fileInput.value = '';
                    sectorInput.value = '';
                    document.getElementById('csvPreview').style.display = 'none';
                    document.getElementById('previewBtn').disabled = true;
                    
                } else {
                    alert(`Upload failed: ${result.error?.message || result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                alert(`Upload error: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        }
        
        function showBatchProgress(uploadResult) {
            const progressSection = document.getElementById('batchProgressSection');
            const groupIdSpan = document.getElementById('batchGroupId');
            const totalKeywordsDiv = document.getElementById('totalKeywords');
            
            groupIdSpan.textContent = uploadResult.group_id;
            totalKeywordsDiv.textContent = uploadResult.total_keywords;
            
            progressSection.style.display = 'block';
            
            // Scroll to progress section
            progressSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function startBatchMonitoring() {
            if (!currentBatchGroupId) return;
            
            // Clear any existing interval
            if (batchStatusInterval) {
                clearInterval(batchStatusInterval);
            }
            
            // Start polling for status updates
            batchStatusInterval = setInterval(async () => {
                await updateBatchStatus();
            }, 2000); // Poll every 2 seconds
            
            // Initial status update
            updateBatchStatus();
        }
        
        async function updateBatchStatus() {
            if (!currentBatchGroupId) return;
            
            try {
                const response = await fetch(`/api/batches/${currentBatchGroupId}/status`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const status = result.status;
                    updateBatchUI(status);
                    
                    // Stop monitoring if completed
                    if (status.status === 'completed' || status.status === 'completed_with_errors') {
                        if (batchStatusInterval) {
                            clearInterval(batchStatusInterval);
                            batchStatusInterval = null;
                        }
                        showBatchResults();
                    }
                }
            } catch (error) {
                console.error('Error updating batch status:', error);
            }
        }
        
        function updateBatchUI(status) {
            // Update progress bar
            const progressBar = document.getElementById('batchProgressBar');
            const progressText = document.getElementById('batchProgressText');
            const completedCount = document.getElementById('completedCount');
            const inProgressCount = document.getElementById('inProgressCount');
            const failedCount = document.getElementById('failedCount');
            
            const totalBatches = status.total_batches;
            const completed = status.completed_batches;
            const inProgress = status.in_progress_batches;
            const failed = status.failed_batches;
            
            const progressPercent = totalBatches > 0 ? (completed / totalBatches) * 100 : 0;
            
            progressBar.style.width = `${progressPercent}%`;
            progressText.textContent = `${completed} / ${totalBatches} batches`;
            
            completedCount.textContent = completed;
            inProgressCount.textContent = inProgress;
            failedCount.textContent = failed;
            
            // Update colors based on status
            if (failed > 0) {
                progressBar.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
            } else if (completed === totalBatches) {
                progressBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
            }
        }
        
        function showBatchResults() {
            const resultsDiv = document.getElementById('batchResults');
            resultsDiv.style.display = 'block';
        }
        
        async function downloadBatchResults() {
            if (!currentBatchGroupId) return;
            
            try {
                const downloadBtn = document.getElementById('downloadBtn');
                const originalText = downloadBtn.textContent;
                
                downloadBtn.disabled = true;
                downloadBtn.textContent = '⏳ Preparing...';
                
                // Create download link
                const link = document.createElement('a');
                link.href = `/api/batches/${currentBatchGroupId}/export.csv`;
                link.download = `newstrack_results_${currentBatchGroupId}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
                
            } catch (error) {
                alert(`Download failed: ${error.message}`);
            }
        }
        
        async function viewBatchResults() {
            if (!currentBatchGroupId) return;
            
            try {
                const response = await fetch(`/api/batches/${currentBatchGroupId}/result`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Show results in the existing results section
                    if (result.results && result.results.length > 0) {
                        // Use the first batch result for display
                        showResults(result.results[0]);
                    } else {
                        alert('No completed results available yet.');
                    }
                } else {
                    alert(`Failed to load results: ${result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                alert(`Error loading results: ${error.message}`);
            }
        }
    </script>
</body>
</html>

